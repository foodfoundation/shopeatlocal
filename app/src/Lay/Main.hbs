{{!-- Main.hbs
//    --------
//    Main layout view --}}

<!DOCTYPE html>

<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport"
		content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="robots" content="noindex">
	{{!-- For use with 'fetch': --}}
	<meta name="csrf-token" content="{{TokCSRF}}">

	<title>{{Title}}</title>

	{{!-- Style sheets
	//    ------------ --}}

	<link rel="stylesheet"
		href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
		integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z"
		crossorigin="anonymous">

	<link rel="stylesheet" href="{{hPrefixStatic 'main-18.css'}}">

	{{!-- Bootstrap scripts
	//    ----------------- --}}

	{{!-- This cannot be 'async' because it will then be unready for some of the
	//    script-containing views, which use JQuery. An alternative is to move
	//    these scripts back to the end of the body, and insert view scripts below
	//    them. Handlebars does not support this directly, but this page shows a
	//    possible fix:
	//
	//    https://www.wolfgang-ziegler.com/blog/a-scripts-section-for-your-handlebars-layout-template
	//
	//    I'm not convinced that it is safe to modify the context within the view,
	//    however. Who knows what order Handlebars might follow when evaluating
	//    the layout template? --}}
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
		crossorigin="anonymous"></script>

	{{!-- For Bootstrap tooltips and popovers: --}}
	<script async
		src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
		integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
		crossorigin="anonymous"></script>

	<script async
		src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
		integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
		crossorigin="anonymous"></script>

	{{!-- For the Bootstrap 'custom-file' component:
	//
	//      https://getbootstrap.com/docs/4.5/components/forms/#file-browser
	//
	// It may not be safe to make this 'async' either: --}}
	<script
		src="https://cdn.jsdelivr.net/npm/bs-custom-file-input@1.3.4/dist/bs-custom-file-input.min.js"
		integrity="sha256-e0DUqNhsFAzOlhrWXnMOQwRoqrCRlofpWgyhnrIIaPo="
		crossorigin="anonymous"></script>

	<script>
		$(document).ready(function () {
			$('[data-toggle="tooltip"]').tooltip();

			bsCustomFileInput.init();
		});
	</script>

	{{!-- Other scripts
	//    ------------- --}}

	<script src="{{hPrefixStatic 'main-8.js'}}"></script>

	{{!-- Google Analytics --}}
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-QKKRX9EPNS"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		let memberId = "noauth";
		{{#if CredUser}}
			memberId = {{CredUser.IDMemb}};
		{{/if}}

		gtag('config', 'G-QKKRX9EPNS', {
			'member_id': memberId,
		});
	</script>

	<!-- Google tag for ads -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-250423055-2">
	</script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-250423055-2');
	</script>

	<script type="text/javascript">
		adroll_adv_id = "C3ASSFI5RBGWLOKETTOJK5";
		adroll_pix_id = "OISDPU3BTJEO5BWXMQOZPF";
		adroll_version = "2.0";

		(function(w, d, e, o, a) {
			w.__adroll_loaded = true;
			w.adroll = w.adroll || [];
			w.adroll.f = [ 'setProperties', 'identify', 'track' ];
			var roundtripUrl = "https://s.adroll.com/j/" + adroll_adv_id
					+ "/roundtrip.js";
			for (a = 0; a < w.adroll.f.length; a++) {
				w.adroll[w.adroll.f[a]] = w.adroll[w.adroll.f[a]] || (function(n) {
					return function() {
						w.adroll.push([ n, arguments ])
					}
				})(w.adroll.f[a])
			}

			e = d.createElement('script');
			o = d.getElementsByTagName('script')[0];
			e.async = 1;
			e.src = roundtripUrl;
			o.parentNode.insertBefore(e, o);
		})(window, document);
		adroll.track("pageView");
	</script>
</head>

<body>

	{{!-- No-JavaScript warning
	//    ---------------------- --}}

	<noscript>
		<div class="Flash alert alert-warning mb-0 pt-1 pb-2" role="alert">
			This site requires JavaScript! Learn
			<a href="https://www.computerhope.com/issues/ch000891.htm"
				class="alert-link">how to enable it</a> in your browser.
		</div>
	</noscript>

	<div id="WarnIE" class="Flash alert alert-warning mb-0 pt-1 pb-2"
		role="alert">
		<div>
			Sorry, this site will not work properly with
			<a href="https://www.engadget.com/2019-02-08-microsoft-internet-explorer-technical-debt.html">Internet Explorer</a>!
			Please upgrade to a modern, secure browser:
		</div>
		<ul class="mb-0">
			<li>
				Google <a href="https://www.google.com/chrome/">Chrome</a>
			</li>
			<li>
				Mozilla <a href="https://www.mozilla.org/en-US/firefox/new/">Firefox</a>
			</li>
			<li>
				Microsoft <a href="https://www.microsoft.com/en-us/edge">Edge</a>
			</li>
		</ul>
	</div>

	{{#if (hCkTest)}}
	<div id="WarnTest">
		TEST<br>SERVER
	</div>
	{{/if}}

	{{!-- Page header
	//    ----------- --}}

	<header class="d-print-none d-flex align-items-center">
		{{!-- A logo to be displayed when the viewport is larger than 'xs': --}}
		<div id="ColLogo">
			<a href="{{CoopParams.HomeWebsite}}">
				<img class="d-none d-md-inline mr-1" src="{{CoopParams.HeaderLogoPath}}" alt=""
					height="30" style="position: relative; top: -0.04rem;">
			</a>
			<a href="{{CoopParams.HomeWebsite}}">
				<img alt="" src="{{CoopParams.TextLogoPath}}" height="30">
			</a>
		</div>

		{{#if CredUser}}
		<div id="ColCart">
			<button id="BtnCart" type="button" class="btn ml-2" data-toggle="modal"
				data-target="#DlgCart">
				<img src="{{hPrefixStatic 'cart_outline.svg'}}" alt="" class="IconBtn"
					width="24" height="24">
				Cart
			</button>
		</div>

		<div id="LblBtnCart" class="d-none d-sm-block ml-2">
			{{>Shop/pLblBtnCart this}}
		</div>
		{{/if}}

		<div class="flex-grow-1 d-flex justify-content-center">
			{{#if FlagBeforeShop}}
				<div class="d-none d-md-block text-left mr-5">
						<span class="header-main-text">
							Cart opens
						</span>
							<br>
						<span class="header-text-secondary">
							{{hTextWhen WhenStartShopNext "Med" "HourMin"}}
						</span>
				</div>
				{{else if FlagShop}}
				<div class="d-none d-md-block text-left mr-5">
						<span class="header-main-text">
							Cart closes
						</span>
							<br>
						<span class="header-text-secondary">
							{{hTextWhen WhenEndShopNext "Med" "HourMin"}}
						</span>
				</div>
				{{/if}}

				{{#if FlagAfterShop}}
				<div class="d-none d-md-block text-left mr-5">
						<span class="header-main-text">
							Next cart opens
						</span>
							<br>
						<span class="header-text-secondary">
							{{hTextWhen WhenStartShopNext "Med" "HourMin"}}
						</span>
				</div>
				{{/if}}
		</div>

		<div class="text-right">
			{{#if CredUser}}
				{{#if (hCkAnd CoopParams.DonateWebsite CoopParams.DonateButtonText CoopParams.DonateButtonTooltip) }}
					<div id="ColWelcome" class="d-flex align-items-center">
						<div class="d-none d-md-block">
							<span class="header-main-text">Welcome<br>{{CredUser.NameLogin}}!</span>
						</div>
						<div id="ColDonate" class="mr-2">
							<a target="_blank" class="btn header-button-orange ml-2" href="{{CoopParams.DonateWebsite}}">
								<span class="Tip" data-toggle="tooltip" data-placement="top" data-html="true"
									title="{{CoopParams.DonateButtonTooltip}}"
								>
									{{CoopParams.DonateButtonText}}
								</span>
							</a>
						</div>
					</div>
				{{/if}}
			{{else}}
			<div id="ColWelcome" class="d-flex align-items-center">
				<div class="d-none d-md-block text-left mr-5">
					<span class="header-main-text">
						Want to become a producer?
						<br>
						<a class="header-text-link" href="mailto:{{CoopParams.InfoEmail}}">Email {{CoopParams.InfoEmail}}</a>
					</span>

				</div>
				<div id="ColDonate" class="mr-2">
					<a target="_blank"  class="btn header-button-orange ml-2"
						href="/member-registration"
					>
						Start free trial!
					</a>
				</div>
			</div>
			{{/if}}
		</div>

		<div id="ColLogin">
			<div class="text-right">
				{{#if CredUser}}
				<div>
					<a href="/logout" class="btn btn-primary" role="button"
						onclick="Disab_Form()">
						Logout
					</a>
				</div>
				{{else}}
				<button type="button" class="btn" data-toggle="modal"
					data-target="#DlgLogin">Login</button>
				{{/if}}
			</div>
		</div>
	</header>

	{{!-- Navigation bar
	//    -------------- --}}

	{{!-- Not that 'navbar-dark' is required to make the Bootstrap menu icon
	//    appear, even if we don't use that background color: --}}
	<nav class="navbar navbar-expand-md navbar-dark">
		<button class="navbar-toggler" type="button" data-target="#Nav, #Nav2"
			data-toggle="collapse">
			<span class="navbar-toggler-icon"></span>
		</button>

		<div id="Nav" class="collapse navbar-collapse">
			<ul class="navbar-nav">
				{{!-- Putting conditional breaks inside double-word headings allows them
				//    to wrap and space properly in the desktop view, without wrapping
				//    in the hamburger menu. Surely there is a better way? [design] --}}

				<li class="nav-item {{hTextIfView "Home/index" "active"}}">
					<a href="/" class="nav-link double">
						Market
						<span class="d-none d-md-inline"><br></span>
						Home
					</a>
				</li>
				{{#if CoopParams.isProductTypesPageDefined}}
				<li class="nav-item">
					<a href="/production-types" class="nav-link double" target="_blank">
						Production
						<span class="d-none d-md-inline"><br></span>
						Types
					</a>
				</li>
				{{/if}}

				{{#if CoopParams.staticPages}}
					{{#each CoopParams.staticPages}}
						<li class="nav-item" style="max-width: 100px;">
							<a href="/pages/{{this.slug}}" class="nav-link double" target="_blank">
								{{this.linkTitle}}
							</a>
						</li>
					{{/each}}
				{{/if}}

				{{#if CredUser}}
				<li class="nav-item {{hTextIfView "Memb/member" "active"}}">
					<a href="/member" class="nav-link double">
					Member
					<span class="d-none d-md-inline"><br></span>
					Account
					</a>
				</li>
				{{#if CredImperUser.CkShowProducer}}
				<li class="nav-item {{hTextIfView "Producer/producer" "active"}}">
					<a {{#if CredImperUser.IDProducer}} href="/producer" {{else}}
						href="/producer-registration" {{/if}}
						class="nav-link double">
						Producer
						<span class="d-none d-md-inline"><br></span>
						Account
						</a>
				</li>
				{{/if}}

				
				{{/if}}
			</ul>
		</div>

	

		{{!-- Display the page title, as the hamburger is normally collapsed. Note
		//    the CSS that hides this when the menu is open, otherwise it would
		//    appear in the menu: --}}
		<div id="TitleMob" class="d-md-none navbar-brand">
			{{hTextIfView "Home/index" "Market Home"}}
			{{hTextIfView "Shop/product-search" "Product Search"}}
			{{hTextIfView "Memb/member" "Member"}}
			{{hTextIfView "Producer/producer" "Producer"}}
			{{hTextIfView "MembAdmin/member-admin" "Member Admin"}}
			{{hTextIfView "ProducerAdmin/producer-admin" "Producer Admin"}}
			{{hTextIfView "Distrib/distribution" "Distribution"}}
			{{hTextIfView "Cashier/cashier" "Accounting"}}
			{{hTextIfView "SiteAdmin/site-admin" "Site Admin"}}
			{{hTextIfView "Onsite/on-site" "On-site"}}
		</div>
	</nav>
	{{#if (hCkStaffFromUser)}}
	<nav id="navbar2" class="navbar navbar-expand-md navbar-dark">
		<div id="Nav2" class="collapse navbar-collapse">
			<ul class="navbar-nav">
				
				<li class="nav-item {{hTextIfView "MembAdmin/member-admin" "active"}}">
					<a href="/member-admin" class="nav-link double">
						Member
						<span class="d-none d-md-inline"><br></span>
						Admin
					</a>
				</li>
				<li
					class="nav-item {{hTextIfView "ProducerAdmin/producer-admin" "active"}}">
					<a href="/producer-admin" class="nav-link double">
						Producer
						<span class="d-none d-md-inline"><br></span>
						Admin
					</a>
				</li>
				<li class="nav-item {{hTextIfView "Distrib/distribution" "active"}}">
					<a href="/distribution" class="nav-link single">Distribution</a>
				</li>
				<li class="nav-item {{hTextIfView "Cashier/cashier" "active"}}">
					<a href="/cashier" class="nav-link single">Accounting</a>
				</li>
				<li class="nav-item {{hTextIfView "Onsite/on-site" "active"}}">
					<a href="/on-site" class="nav-link single">
						On-site
					</a>
				</li>
				<li class="nav-item {{hTextIfView "SiteAdmin/site-admin" "active"}}">
					<a href="/site-admin" class="nav-link double">
						Site
						<span class="d-none d-md-inline"><br></span>
						Admin
					</a>
				</li>
				
			</ul>
		</div>
	</nav>
	{{/if}}

	{{!-- Impersonation bar
	//    ----------------- --}}

	{{#if CredImper}}
	<div id="BarImper" class="d-flex align-items-center">
		<p class="d-inline-block my-1 mr-auto">Impersonating
			<a href="/member-detail/{{CredImper.IDMemb}}">
				Member {{hTextIDMemb CredImper.IDMemb}}
				<strong>{{CredImper.Name1First}} {{CredImper.Name1Last}}</strong>
			</a>
			{{#if CredImper.IDProducer}}
			/ <a href="/producer-detail/{{CredImper.IDProducer}}">
				Producer {{hTextIDProducer CredImper.IDProducer}}
				<strong>{{CredImper.NameBusProducer}}</strong>
			</a>
			{{/if}}
		</p>

		<form id="FormStopImper" class="m-2" action="/stop-impersonation"
			method="POST" novalidate onsubmit="Disab_Form()">

			<input type="hidden" name="_csrf" value="{{TokCSRF}}">
			<input type="hidden" name="URLReturn" value="{{URL}}">

			<button type="submit" class="btn btn-sm btn-warning">
				Stop impersonating
			</button>
		</form>
	</div>
	{{/if}}

	{{!-- Flash messages
	//    -------------- --}}

	<div id="Flashes">
		{{#each Flashes}}
		{{>Misc/pFlash this}}
		{{/each}}
	</div>

	{{!-- Login dialog
	//    ------------ --}}

	<div id="DlgLogin" class="modal" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<form action="/login" method="POST" onsubmit="Disab_Form()">
					<input type="hidden" name="_csrf" value="{{TokCSRF}}">

					<div class="modal-body">
						<div class="form-group">
							<label for="NameLogin">Username</label>
							<input id="NameLogin" name="NameLogin" type="text" required
								minlength="1" class="form-control">
						</div>

						<div class="form-group">
							<label for="Pass">Password</label>
							<input id="Pass" name="Pass" type="password" required
								minlength="1" class="form-control">
						</div>
					</div>

					<div class="modal-footer">
						<a href="/request-password-reset">
							Forgot your password?
						</a>
						<button type="button" class="btn btn-secondary ml-auto"
							data-toggle="modal" data-target="#DlgLogin">
							Cancel
						</button>
						<button type="submit" class="btn btn-primary">
							Login
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	{{!-- First Item in cart Notice
	//    ------------ --}}

	<div id="DlgNotice" class="modal show" tabindex="-1" role="dialog" style="z-index: 2000; background-color: rgba(0, 0, 0, 0.35);">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header alert-warning" style="background-color: #fff3cd !important;">
						<h5 class="modal-title">Notice</h5>
				</div>
				<div class="modal-body">
					<p>
						When the cart closes all items in your cart become your order and are sent to producers to harvest, pick and pack.
					</p>
					<p>
						You are committing to pay for the items in your cart at pick up time.
					</p>
					<p>
						<strong>Happy shopping!</strong> 
					</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary ml-auto"
						data-toggle="modal" data-target="#DlgNotice">
						OK
					</button>
				</div>
			</div>
		</div>
	</div>

	

	{{!-- Cart dialog
	//    ----------- --}}

	{{#if CredUser}}
	<div id="DlgCart" class="modal" tabindex="-1" role="dialog">
		<div class="modal-dialog modal-xxl">
			<div class="modal-content">
				{{!-- This form is submitted with 'fetch', so neither 'action' nor
				//    'method' are needed. Form_Disab is called by the Save button
				//    handler: --}}
				<form id="FormCart">
					<input type="hidden" name="_csrf" value="{{TokCSRF}}">

					<div class="modal-header justify-content-start align-items-center
						py-2 px-3">
						<img src="{{hPrefixStatic 'cart.svg'}}" alt=""
							class="d-none d-md-block mt-1 mr-3" width="30" height="30">

						<h3 class="mb-0">
							{{#if CkSelImperUserSelf}}
							Shopping cart
							{{else}}
							{{CredSelImperUser.NameLogin}}'s shopping cart
							{{/if}}
						</h3>

						<div class="d-none d-sm-block text-right font-size-90 ml-auto">
							{{#if FlagShop}}
							Cart closes {{hTextDateTimeMed WhenEndShopNext}}<br>
							{{/if}}
							Order pickup starts <a href="{{CoopParams.PickupWebsite}}">
								{{hTextDateMed WhenStartPickupNext}}</a>
						</div>
					</div>

					<div class="modal-body pb-0">
						<div class="form-row">
							<div class="form-group col-md-3 mb-2 mb-md-0">
								{{#if SummCartImperUser}}
									{{#if FlagShop}}
										<label for="CdLoc">Pickup location</label>
										<select id="SelCdLoc" name="CdLoc" value="{{CdLoc}}"
											class="custom-select">
											{{>Shop/pSelCdLoc this}}
										</select>
									{{else}}
										<div class="mb-1">Pickup location</div>
										<div class="text-uppercase font-weight-bold font-size-120">
											{{hNameLocFromCd SummCartImperUser.CdLoc}}
										</div>
									{{/if}}
								{{else}}
									<div class="mb-1">Pickup location</div>
									<div class="text-uppercase font-weight-bold font-size-120">
										{{hNameLocFromCd CredUser.CdLocLast}}
									</div>
								{{/if}}
							</div>
							<div class="offset-md-1 col-md-8 text-md-right font-size-90
								mb-3 mb-md-0">
								{{#if CoopParams.shoppingCartInformationText}}{{{CoopParams.shoppingCartInformationText}}}{{/if}}
							</div>
						</div>

						<div id="SummCart">
							{{>Shop/pSummCart this}}
						</div>
					</div>

					<div class="modal-footer p-2">
						<button id="BtnCloseCart" class="btn btn-secondary" type="button"
							data-toggle="modal" data-target="#DlgCart">
							Close
						</button>

						<button id="BtnCancelCart" class="d-none btn btn-secondary"
							type="button">
							Cancel
						</button>

						{{!-- Display this even if the cart is empty. The user might want to
						//    change the pickup location: --}}
						<button id="BtnSaveCart" class="d-none btn btn-primary"
							type="submit">
							Save
						</button>
					</div>
				</form>

				<script>
					$("#SelCdLoc").on("change", OnChg_FormCart);

					$("#BtnCancelCart").on("click", OnCancel_FormCart);
					$("#FormCart").on("submit", OnSave_FormCart);
				</script>
			</div>
		</div>
	</div>
	{{/if}}

	{{!-- Page content
	//    ------------ --}}

	<main>
		{{{body}}}
	</main>

	{{!-- Page footer
	//    ----------- --}}

	<footer class="page-footer p-3 bg-dark text-light">
		<div class="d-sm-flex">
			<div class="d-none d-sm-block pl-1 pt-1">
				<a href="{{CoopParams.HomeWebsite}}">
					<img class="Seal" src="{{CoopParams.FooterLogoPath}}" alt=""
						width="120">
				</a>
			</div>

			<div class="flex-grow-1 ml-sm-4 mr-4">
				<address class="mb-sm-0">
					<span class="text-uppercase font-size-110">{{CoopParams.CoopNameBusiness}}</span><br>
					{{CoopParams.AddressLine1}}<br>
					{{CoopParams.AddressLine2}}<br>
					{{hLinkPhone CoopParams.Phone}}<br>
					<a href="mailto:{{CoopParams.HelpEmail}}" target="_top">
						{{CoopParams.HelpEmail}}
					</a>
				</address>
			</div>

			<div class="ml-auto mr-3 mr-md-3">
				<div class="text-uppercase font-size-110 mb-1">Links</div>
				{{!-- Couldn't get this to work right with 'row/col'. Containing 'div'
				//    consumed extra space, yet 'Shopping calendar' line wrapped: --}}
				<div class="d-md-flex">
					<div class="mr-md-4">
						<a href="{{CoopParams.HomeWebsite}}">
							{{CoopParams.CoopNameShort}} Home
						</a>
						</br>
						{{#if CoopParams.staticPages}}
  							{{#each CoopParams.staticPages}}
    							<a href="/pages/{{this.slug}}">
      								{{this.linkTitle}}
    							</a>
								</br>
  							{{/each}}
						{{/if}}
					</div>
					<div>
						<a href="/terms-and-conditions">
							Terms of service
						</a><br>
						<a href="/acknowledgments">
							Acknowledgments
						</a>
						{{#if CredUser}}
						<br>
						<a target="_blank" href="https://cultivatefoodconnections.org/donate">
							Make a donation!
						</a>
						{{else}}
						<br>
						<a href="/member-registration">
							Start free trial!
						</a>
						{{/if}}
					</div>
				</div>
			</div>
		</div>
	</footer>

	<script>
		$(".navbar-toggler").click(function() {
  			$("#navbar2").toggle();
		});
		// Focus the name field when the Login dialog is displayed. 'autofocus' does
		// not work there:
		$("#DlgLogin").on("shown.bs.modal", function() {
			$("#NameLogin").trigger("focus");
		});

		// Shared handlers
		// ---------------
		// These handlers are re-used throughout the app.

		$("input.InputQty").on("input", Rem_ChNonQty);
		$("input.InputWgt").on("input", Rem_ChNonWgt);
		$("input.InputFee").on("input", Rem_ChNonFee);
	</script>
</body>

</html>
